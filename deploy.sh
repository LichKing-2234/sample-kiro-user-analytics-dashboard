#!/bin/bash
set -e

echo "ðŸ“Š Kiro Users Report â€” One-Click Deploy"
echo "================================"

# â”€â”€ Prerequisites â”€â”€
command -v terraform >/dev/null 2>&1 || { echo "âŒ Terraform is required. Install: https://www.terraform.io/downloads"; exit 1; }
command -v aws >/dev/null 2>&1 || { echo "âŒ AWS CLI is required. Install: https://aws.amazon.com/cli/"; exit 1; }

# â”€â”€ Step 1: Terraform setup â”€â”€
echo ""
echo "ðŸ“ Step 1: Terraform configuration"

if [ ! -f "terraform/terraform.tfvars" ]; then
    echo "Creating terraform.tfvars from example..."
    cp terraform/terraform.tfvars.example terraform/terraform.tfvars
    echo ""
    echo "âš ï¸  Please edit terraform/terraform.tfvars with your values:"
    echo "   - aws_account_id"
    echo "   - s3_bucket_name"
    echo "   - glue_database_name"
    echo "   - identity_store_id (required, for username lookup)"
    echo ""
    read -p "Press Enter when ready to continue..."
fi

# â”€â”€ Step 2: Terraform init + apply â”€â”€
echo ""
echo "ðŸ”§ Step 2: Deploying infrastructure"

terraform -chdir=terraform init
terraform -chdir=terraform plan

read -p "Apply this plan? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo "Cancelled."
    exit 0
fi

terraform -chdir=terraform apply -auto-approve

# â”€â”€ Step 3: Extract outputs â†’ app/.env â”€â”€
echo ""
echo "âš™ï¸  Step 3: Configuring application"

AWS_REGION=$(terraform -chdir=terraform output -raw aws_region)
DATABASE_NAME=$(terraform -chdir=terraform output -raw glue_database_name)
ATHENA_OUTPUT=$(terraform -chdir=terraform output -raw athena_output_location)
IDENTITY_STORE_ID=$(terraform -chdir=terraform output -raw identity_store_id)

cat > app/.env << EOF
# Generated by deploy.sh on $(date)
AWS_REGION=${AWS_REGION}
ATHENA_DATABASE=${DATABASE_NAME}
ATHENA_OUTPUT_BUCKET=${ATHENA_OUTPUT}
IDENTITY_STORE_ID=${IDENTITY_STORE_ID}
EOF

echo "âœ… Created app/.env"
cat app/.env

# â”€â”€ Step 4: Run Glue crawler â”€â”€
echo ""
echo "ðŸ•·ï¸  Step 4: Running Glue crawler"

CRAWLER_NAME=$(terraform -chdir=terraform output -raw glue_crawler_name)
aws glue start-crawler --name "${CRAWLER_NAME}"

echo "Waiting for crawler to finish (may take a few minutes)..."
while true; do
    STATUS=$(aws glue get-crawler --name "${CRAWLER_NAME}" --query 'Crawler.State' --output text)
    if [ "$STATUS" = "READY" ]; then break; fi
    echo "  Crawler status: $STATUS"
    sleep 10
done
echo "âœ… Crawler completed"

# â”€â”€ Step 5: Launch dashboard â”€â”€
echo ""
echo "ðŸš€ Step 5: Launching dashboard"
echo ""
echo "Run the following command to start the dashboard:"
echo ""
echo "cd app && python -m venv venv && source venv/bin/activate && pip install -r requirements.txt && streamlit run app.py"
echo ""
echo "âœ… Deploy complete!"
